--Vista para ver el nombre y precio de los productos agregados a los pedidos
CREATE VIEW orders AS
SELECT PP.pdid AS id_pedido, P.nombre, P.precio
FROM productos AS P
JOIN pedidosproductos AS PP 
ON pp.prid = p.prid;

SELECT * FROM orders

--Vista para ver el id del pedido y la suma total a pagar por pedido
CREATE VIEW valor_pedido AS
SELECT PD.pdid AS id_pedido, SUM(P.precio) AS valor_total_pedido
FROM productos AS P
JOIN pedidosProductos AS PP
ON PP.prid = p.prid
JOIN pedidos AS PD
ON PD.pdid = PP.pdid
GROUP BY id_pedido
ORDER BY id_pedido ASC;

SELECT * FROM valor_pedido

--Funcion para ver los productos disponibles
CREATE OR REPLACE FUNCTION function_products_available()
RETURNS TRIGGER AS $function_products_available$	
BEGIN
	UPDATE productos AS P
	SET	P.cantidad = P.cantidad - NEW.cantidad
	WHERE P.prid = NEW.prid;
	
RETURN NEW;
END
$function_products_available$ LANGUAGE plpgsql;

--Trigger para ver los productos disponibles.
CREATE TRIGGER trigger_products_available
AFTER INSERT ON pedidos
FOR EACH ROW 
EXECUTE PROCEDURE function_products_available(); 



